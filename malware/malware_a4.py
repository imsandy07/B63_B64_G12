import os
import csv
from pathlib import Path

# Dictionary of known file signatures (magic numbers)
FILE_SIGNATURES = {
    "504B0304": ("ZIP Archive", ".zip"),
    "89504E47": ("PNG Image", ".png"),
    "D0CF11E0": ("Microsoft Office Document (Pre-2007)", ".doc, .xls, .ppt"),
    "3C21444F": ("HTML File", ".html"),
    "49443303": ("MP3 Audio File", ".mp3"),
    "25504446": ("PDF Document", ".pdf"),
    "47494638": ("GIF Image", ".gif"),
    "3026B275": ("Windows Media File (ASF)", ".wmv, .wma"),
    "00000018": ("MP4 Video File", ".mp4"),
    "52617221": ("RAR Archive", ".rar"),
}

def read_file_signature(file_path, num_bytes=8):
    """Read the first few bytes of a file (magic number)."""
    with open(file_path, "rb") as f:
        return f.read(num_bytes).hex().upper()

def identify_file_type(hex_signature):
    """Identify file type and extension based on magic numbers."""
    for sig, (file_type, extension) in FILE_SIGNATURES.items():
        if hex_signature.startswith(sig):
            return file_type, extension
    return "Unknown", "Unknown"

def analyze_files(directory):
    """Analyze all files in a directory to determine file types."""
    results = []
    for filename in os.listdir(directory):
        file_path = os.path.join(directory, filename)

        if not os.path.isfile(file_path):
            continue  # Skip directories

        hex_sig = read_file_signature(file_path)
        file_type, extension = identify_file_type(hex_sig)

        # Rename file if type is recognized
        if extension != "Unknown":
            new_file_path = file_path + extension.split(",")[0]  # Use first suggested extension
            os.rename(file_path, new_file_path)
            results.append((filename, hex_sig, file_type, extension, new_file_path))
        else:
            results.append((filename, hex_sig, file_type, extension, "Not Renamed"))

    return results

def save_results_to_csv(results, output_file="file_analysis_results.csv"):
    """Save analysis results to a CSV file."""
    with open(output_file, mode="w", newline="") as file:
        writer = csv.writer(file)
        writer.writerow(["Filename", "Hex Signature", "Detected Type", "Suggested Extension", "New File Path"])
        writer.writerows(results)

def main():
    directory = input("Enter the directory containing the files: ").strip()

    if not os.path.exists(directory):
        print("Error: Directory not found!")
        return

    print("\nAnalyzing files...\n")
    results = analyze_files(directory)

    save_results_to_csv(results)

    print("\nâœ… Analysis complete! Results saved to 'file_analysis_results.csv'.\n")
    for row in results:
        print(f"File: {row[0]} | Type: {row[2]} | Extension: {row[3]} | Renamed to: {row[4]}")

if __name__ == "__main__":
    main()
